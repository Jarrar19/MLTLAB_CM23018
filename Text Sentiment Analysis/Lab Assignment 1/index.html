<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LabAssignment1 - IMDB Sentiment RNN</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>

<h2>LabAssignment1: Train Sentiment RNN (IMDB Dataset)</h2>
<button onclick="loadAndTrain()">Load Dataset & Train</button>

<script>

let texts = [];
let labels = [];
let wordIndex = {};
let vocabSize;
const MAX_LEN = 100;
const MAX_SAMPLES = 200;

function loadAndTrain() {

    console.log("Loading IMDB CSV...");

    Papa.parse("IMDB Dataset.csv", {
        download: true,
        header: true,
        complete: async function(results) {

            results.data.slice(0, MAX_SAMPLES).forEach(row => {
                texts.push(row.review.toLowerCase());
                labels.push(row.sentiment === "positive" ? 1 : 0);
            });

            console.log("Loaded samples:", texts.length);
            await trainModel();
        }
    });
}

function buildVocab() {
    let index = 1;
    texts.forEach(text => {
        text.split(/\W+/).forEach(word => {
            if(word && !wordIndex[word]) {
                wordIndex[word] = index++;
            }
        });
    });
    vocabSize = index;
}

function encode(texts) {
    return texts.map(text => {
        const seq = text.split(/\W+/).map(w => wordIndex[w] || 0);
        if(seq.length > MAX_LEN) return seq.slice(0,MAX_LEN);
        while(seq.length < MAX_LEN) seq.push(0);
        return seq;
    });
}

async function trainModel() {

    console.log("Building vocabulary...");
    buildVocab();

    console.log("Encoding...");
    const xs = tf.tensor2d(encode(texts));
    const ys = tf.tensor2d(labels, [labels.length,1]);

    console.log("Building RNN...");
    const model = tf.sequential();
    model.add(tf.layers.embedding({
        inputDim: vocabSize,
        outputDim: 16,
        inputLength: MAX_LEN
    }));
    model.add(tf.layers.simpleRNN({units:32}));
    model.add(tf.layers.dense({units:1, activation:'sigmoid'}));

    model.compile({
        optimizer:'adam',
        loss:'binaryCrossentropy',
        metrics:['accuracy']
    });

    console.log("Training...");
    const history = await model.fit(xs, ys, {
        epochs:5,
        batchSize:16,
        validationSplit:0.2
    });

    const acc = history.history.acc.slice(-1)[0];
    const valAcc = history.history.val_acc.slice(-1)[0];

    console.log("Train Accuracy:", (acc*100).toFixed(2)+"%");
    console.log("Val Accuracy:", (valAcc*100).toFixed(2)+"%");
}

</script>

</body>
</html>
